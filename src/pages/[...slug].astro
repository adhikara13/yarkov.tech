---
import type { MDXInstance } from "astro";

import ArticleLayout from "@layouts/article.astro";
import { getLanguageFromURL } from "@root/utils";
import { DEFAULT_LANGUAGE } from "@root/config";

const lang = getLanguageFromURL(Astro.url.pathname);
const canonicalUrl = new URL(Astro.url.pathname, Astro.site);

export async function getStaticPaths() {
	const modules = import.meta.glob<MDXInstance<ArticleType>>("../../content/articles/**/*.mdx", { eager: true });
	const entries = Object.keys(modules).map((key) => [key, key.split("/").slice(6)[0]]);

	return entries.map(([key, lang]) => {
		const article = modules[key];
		const published_at = new Date(article.frontmatter.published_at).toLocaleDateString("en-CA");
		const slug = `${lang !== DEFAULT_LANGUAGE ? `${lang}/` : ""}blog/${published_at}/${article.frontmatter.slug}`;

		return { params: { slug }, props: article };
	});
}

const { Content, frontmatter } = Astro.props as MDXInstance<ArticleType>;
---

<ArticleLayout lang={lang} content={frontmatter} canonicalUrl={canonicalUrl.href}>
	<Content />
</ArticleLayout>
